<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Edge Monitor | Usuários</title>

    <!-- Bootstrap -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />

    <!-- Estilos globais -->
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>

<header class="app-header">
    <h1>Edge Monitor</h1>

    <nav>
        <a href="dashboard.html">Dashboard</a>
        <a href="users.html">Usuários</a>
        <button id="logout-btn">Sair</button>
    </nav>
</header>

<main class="dashboard-container">

    <section class="mb-4">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
            <div>
                <h2 class="fw-semibold mb-1">Gestão de Usuários</h2>
                <p class="text-muted mb-0">
                    Administração de usuários do sistema
                </p>
            </div>

            <div>
                <a
                    href="user-form.html"
                    class="btn btn-action"
                    id="btn-create-user"
                >
                    Novo Usuário
                </a>
            </div>
        </div>
    </section>

    <section class="users-table-section">

        <div class="users-card-header">
            Usuários cadastrados
        </div>

        <div class="table-responsive">
            <table class="table users-table align-middle mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Usuário</th>
                        <th>E-mail</th>
                        <th class="text-end">Ações</th>
                    </tr>
                </thead>

                <tbody id="users-table-body"></tbody>
            </table>
        </div>

        <p id="users-empty" class="text-muted mt-3" hidden>
            Nenhum usuário encontrado.
        </p>

    </section>

</main>

<script type="module">
    import { requireAuth } from "./js/guard.js";
    import { listUsers, deleteUser } from "./js/users.js";
    import { logout } from "./js/auth.js";

    requireAuth();

    const tableBody = document.getElementById("users-table-body");
    const emptyMessage = document.getElementById("users-empty");
    const logoutBtn = document.getElementById("logout-btn");
    const createBtn = document.getElementById("btn-create-user");

    const isStaff = localStorage.getItem("is_staff") === "true";
    const isSuperuser = localStorage.getItem("is_superuser") === "true";
    const currentUserId = Number(localStorage.getItem("user_id"));

    logoutBtn.addEventListener("click", () => logout());

    // Usuário comum não cria usuários
    if (!isStaff && !isSuperuser) {
        createBtn.remove();
    }

    async function loadUsers() {
        try {
            const users = await listUsers();

            if (!users.length) {
                emptyMessage.hidden = false;
                return;
            }

            users.forEach(user => {
                const row = document.createElement("tr");

                let actions = "-";

                /**
                 * REGRAS DE VISUALIZAÇÃO:
                 * - Admin / Superuser: veem tudo
                 * - Usuário comum: vê SOMENTE os próprios botões
                 */
                if (isSuperuser || isStaff || user.id === currentUserId) {
                    actions = `
                        <button
                            class="btn btn-outline-secondary btn-sm"
                            data-action="edit"
                            data-id="${user.id}">
                            Editar
                        </button>

                        <button
                            class="btn btn-outline-danger btn-sm"
                            data-action="delete"
                            data-id="${user.id}">
                            Excluir
                        </button>
                    `;
                }

                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.username}</td>
                    <td>${user.email || "-"}</td>
                    <td class="text-end">
                        <div class="d-inline-flex gap-2">
                            ${actions}
                        </div>
                    </td>
                `;

                tableBody.appendChild(row);
            });

        } catch {
            emptyMessage.textContent = "Erro ao carregar usuários.";
            emptyMessage.hidden = false;
        }
    }

    tableBody.addEventListener("click", async (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) return;

        const userId = Number(button.dataset.id);
        const action = button.dataset.action;

        // ===== EDITAR =====
        if (action === "edit") {
            window.location.href = `user-form.html?id=${userId}`;
            return;
        }

        // ===== EXCLUIR =====
        if (action === "delete") {
            if (!confirm("Deseja realmente excluir este usuário?")) return;

            try {
                await deleteUser(userId);
                window.location.reload();
            } catch {
                alert("Você não tem permissão para excluir este usuário.");
            }
        }
    });

    loadUsers();
</script>

</body>
</html>
