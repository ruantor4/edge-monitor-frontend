<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Edge Monitor | Dashboard</title>

    <!-- Bootstrap -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    />

    <!-- CSS do projeto -->
    <link rel="stylesheet" href="css/styles.css" />
</head>
<body>

<!-- ======================================================
     HEADER GLOBAL
====================================================== -->
<header class="app-header">
    <h1>Edge Monitor</h1>

    <nav aria-label="Navegação principal">
        <a href="dashboard.html">Dashboard</a>
        <a href="users.html">Usuários</a>
        <button id="logout-btn">Sair</button>
    </nav>
</header>

<!-- ======================================================
     CONTEÚDO PRINCIPAL
====================================================== -->
<main class="container dashboard-container">

    <!-- TÍTULO -->
    <section class="mb-4">
        <h2 class="fw-semibold">Dashboard</h2>
        <p class="text-muted mb-0">
            Consulta de ocorrências de monitoramento
        </p>
    </section>

    <!-- ==================================================
         MÉTRICAS
    =================================================== -->
    <section class="metrics-section mb-4">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="metric-card">
                    <span>Total</span>
                    <strong id="metric-total">0</strong>
                </div>
            </div>

            <div class="col-md-3">
                <div class="metric-card">
                    <span>Críticos</span>
                    <strong id="metric-critical">0</strong>
                </div>
            </div>

            <div class="col-md-3">
                <div class="metric-card">
                    <span>Normais</span>
                    <strong id="metric-normal">0</strong>
                </div>
            </div>

            <div class="col-md-3">
                <div class="metric-card">
                    <span>Último evento</span>
                    <strong id="metric-last">—</strong>
                </div>
            </div>
        </div>
    </section>

    <!-- ==================================================
         FILTROS
    =================================================== -->
    <section class="filters-section mb-4">
        <h3 class="h6 fw-semibold mb-3">Filtros</h3>

        <form id="filters-form" novalidate>
            <div>
                <label>
                    Data inicial
                    <input type="date" name="start_date" required />
                </label>
            </div>

            <div>
                <label>
                    Data final
                    <input type="date" name="end_date" required />
                </label>
            </div>

            <button type="submit">
                Buscar
            </button>
        </form>

        <p id="filters-error" aria-live="polite"></p>
    </section>

    <!-- ==================================================
         RESULTADOS
    =================================================== -->
    <section class="results-section">
        <h3 class="h6 fw-semibold mb-3">Ocorrências</h3>

        <div id="events-container" class="events-list"></div>
    </section>

</main>

<!-- ======================================================
     MODAL DE IMAGEM
====================================================== -->
<dialog id="image-modal">
    <img id="modal-image" alt="Evidência ampliada" />
</dialog>

<!-- ======================================================
     SCRIPTS
====================================================== -->
<script type="module">
    import { listDashboardEvents } from "./js/events.js";
    import { logout } from "./js/auth.js";

    const form = document.getElementById("filters-form");
    const errorBox = document.getElementById("filters-error");
    const container = document.getElementById("events-container");
    const logoutBtn = document.getElementById("logout-btn");

    const modal = document.getElementById("image-modal");
    const modalImage = document.getElementById("modal-image");

    logoutBtn.addEventListener("click", () => logout());

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        errorBox.textContent = "";
        container.innerHTML = "";

        const startDate = form.start_date.value;
        const endDate = form.end_date.value;

        if (!startDate || !endDate) {
            errorBox.textContent =
                "Data inicial e data final são obrigatórias";
            return;
        }

        try {
            const events = await listDashboardEvents(startDate, endDate);

            document.getElementById("metric-total").textContent = events.length;

            const critical = events.filter(
                e => e.class_name === "CRITICAL"
            ).length;

            document.getElementById("metric-critical").textContent = critical;
            document.getElementById("metric-normal").textContent =
                events.length - critical;

            document.getElementById("metric-last").textContent =
                events.length
                    ? new Date(events[0].datetime).toLocaleString()
                    : "—";

            if (!events.length) {
                container.innerHTML =
                    `<div class="text-muted">Nenhuma ocorrência encontrada.</div>`;
                return;
            }

            events.forEach(event => {
                const card = document.createElement("div");
                card.className = "event-card";

                card.innerHTML = `
                    <div class="event-image">
                        <img
                            src="${event.image}"
                            alt="Evidência"
                            data-full="${event.image}"
                        />
                    </div>

                    <div class="event-info">
                        <span class="badge ${
                            event.class_name === "CRITICAL"
                                ? "bg-danger"
                                : "bg-secondary"
                        }">
                            ${event.class_name}
                        </span>

                        <div class="event-mac">${event.mac}</div>
                        <div class="event-date">
                            ${new Date(event.datetime).toLocaleString()}
                        </div>
                    </div>
                `;

                container.appendChild(card);
            });

        } catch (error) {
            errorBox.textContent =
                "Erro ao consultar eventos. Sessão pode ter expirado.";
        }
    });

    container.addEventListener("click", event => {
        if (event.target.tagName === "IMG") {
            modalImage.src = event.target.dataset.full;
            modal.showModal();
        }
    });

    modal.addEventListener("click", () => modal.close());
</script>

</body>
</html>
